<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>When is indexing in a model appropriate?</title>
    <link rel="stylesheet" href="/assets/css/style.css">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      <nav>
        <a href="/">List of All Articles</a>
      </nav>
      <h1>When is indexing in a model appropriate?</h1>
      <section>
        <p>A user on Reddit says:</p>

<blockquote>
  <p>I’m not a DB ninja like a lot of developers as I started out more front end and moved towards full stack. I understand the point of indexing is to speed up SQL queries on large data sets, but I feel like I’m just not sure when to use them and when not to.</p>

  <p>What is the current best practice with rails?</p>
</blockquote>

<p>Uncertainty often stems from a lack of understanding, and indexes in your Rails app can, if you’re not familiar with them, be akin to those murky backwaters you rarely venture into. But it needn’t be. Indexing done right can make a huge difference to the performance and speed of your app, which more often than not, will translate into increased sales, conversions or whatever it is you measure to determine if your app’s ultimate purpose is being fulfilled.</p>

<h2 id="what-is-an-index">What is an index?</h2>

<p>An index is a database construct that makes it easier for the database to look up a given piece of information. An oft cited example, which brings the point home, is that of a phone book index. Imagine you wanted to look up one Rick Sanchez’s phone number – what would be faster? Looking through each page of the book one by one, or flipping back to the index which conveniently lists in alphabetical order the page number Rick’s phone number might be found in? Of course, the index would be way faster. And the positive performance effects multiply the more times you have to look up phone numbers.</p>

<p>Now, when someone moves in or out of Rick’s locality (which the phone book covers), or someone’s name or phone number changes, the index at the back will also have to be updated. This <em>might</em> end up costing you performance if you’re not careful.</p>

<h2 id="why-use-an-index">Why use an index?</h2>

<p>If we represented the phone book example in database terms, we’d probably have a <code class="language-plaintext highlighter-rouge">PhoneBook</code> table, with a <code class="language-plaintext highlighter-rouge">name</code> and <code class="language-plaintext highlighter-rouge">phone_number</code> column. Adding an index to the table on the <code class="language-plaintext highlighter-rouge">name</code> column, makes it easier and faster for the database to look up a phone number for a given name (say when you do something like <code class="language-plaintext highlighter-rouge">PhoneBook.where(name: 'Morty Smith')</code> ), especially if there are a large number of rows to look through.</p>

<p><strong>So the main reason to use an index on a given column is increased speed, which will more often than not, translate into more sales, conversions or whatever it is you measure to determine if your app’s ultimate purpose is being fulfilled.</strong></p>

<p>Note that although we’re just talking about indexing on one column, it is actually possible to index on multiple columns too. I’ll list out resources at the end of this article which will go more in depth into topics like this.</p>

<h2 id="when-to-use-an-index">When to use an index</h2>

<p>If you’re with me so far, it’s clear to you that an index on a column makes it faster for the database to look up a row or a set of rows which satisfy a given condition on that column. With that, we can come up with a rule of thumb:</p>

<p><strong>You should add an index on a column if most (or many) of the queries you write for the table involve that column.</strong></p>

<p>In a typical Rails application, there’s one type of column that is pretty much guaranteed to be involved in most queries for tables that it is in, and that is the <a href="/all-about-foreign-keys">foreign key column</a>.</p>

<p>Let’s consider an example.</p>

<p>Say you have a <code class="language-plaintext highlighter-rouge">User</code> and a <code class="language-plaintext highlighter-rouge">Post</code> model, and the <code class="language-plaintext highlighter-rouge">User</code> <code class="language-plaintext highlighter-rouge">has_many :posts</code>. This of course means that the <code class="language-plaintext highlighter-rouge">:posts</code> table has a foreign key column <code class="language-plaintext highlighter-rouge">user_id</code>, and that whenever we do something like <code class="language-plaintext highlighter-rouge">@user.posts</code> or <code class="language-plaintext highlighter-rouge">@post.user</code>, we are asking the database to look up a given <code class="language-plaintext highlighter-rouge">user_id</code> for one or many <code class="language-plaintext highlighter-rouge">Post</code> records. Without an index, the database would have to look up each row in the <code class="language-plaintext highlighter-rouge">posts</code> table, one by one, to see if their <code class="language-plaintext highlighter-rouge">user_id</code> matched what was given. If there are many <code class="language-plaintext highlighter-rouge">Post</code> records (in other words, if <code class="language-plaintext highlighter-rouge">Post.count</code> returns a huge number), then this would take a lot of time. So, we would add an index to the <code class="language-plaintext highlighter-rouge">posts</code> table on <code class="language-plaintext highlighter-rouge">user_id</code>.</p>

<p>Right now, you’ll have to take my word for it that this is an improvement. But I’ll cover how you can verify this for yourself very soon.</p>

<p>So, <strong>add indexes by default to your foreign key columns. This is considered a standard Rails practice.</strong></p>

<p>“Non-foreign key” columns can also be good candidates for adding indexes on. If they’re referred to a lot in your table queries, and you have a sizable number of rows in your table, then it would probably benefit you to add an index on them. Common examples I’ve come across in my experience are the <code class="language-plaintext highlighter-rouge">date_of_birth</code>, <code class="language-plaintext highlighter-rouge">email</code>, <code class="language-plaintext highlighter-rouge">name</code> columns in a <code class="language-plaintext highlighter-rouge">User</code> table. Remember to apply the rule of thumb discussed above if you’re unsure.</p>

<h2 id="how-to-index">How to Index</h2>

<p>You know what an index is and when to use it. Here’s where we cover how you can begin to actually use them in your Rails app.</p>

<h3 id="when-youre-associating-two-models-with-no-prior-connection">When you’re associating two models with no prior connection</h3>

<p>If you have two models which you want to associate, you know that you have to create a foreign key column on one of them. It turns out that in Rails 4 and beyond, you can create an index at the same time (which you would want to do in most cases), with the <a href="http://apidock.com/rails/ActiveRecord/ConnectionAdapters/SchemaStatements/add_reference"><code class="language-plaintext highlighter-rouge">add_reference</code></a> method.</p>

<p>Say you’ve created a <code class="language-plaintext highlighter-rouge">User</code> and <code class="language-plaintext highlighter-rouge">Post</code> model, and you want to set up a <code class="language-plaintext highlighter-rouge">has_many</code> relationship between them in your DB, you could do this in your console:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g migration AddUserToPosts user:references
</code></pre></div></div>

<p>which will generate a migration which uses the ‘add_reference` method like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_reference :posts, :user, index: true
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">add_reference</code> method will not only create a <code class="language-plaintext highlighter-rouge">user_id</code> column on your <code class="language-plaintext highlighter-rouge">Post</code> table, but also add an index on <code class="language-plaintext highlighter-rouge">user_id</code>. Nifty. You can also pass in <code class="language-plaintext highlighter-rouge">foreign_key: true</code> to this method to add in a <a href="/all-about-foreign-keys">database constraint</a></p>

<h3 id="adding-an-index-to-an-existing-association">Adding an index to an existing association</h3>

<p>If for some reason, you don’t have access to the <code class="language-plaintext highlighter-rouge">add_reference</code> method, or you’ve already created a <code class="language-plaintext highlighter-rouge">user_id</code> column without adding an index to it, you can use the <a href="http://apidock.com/rails/ActiveRecord/ConnectionAdapters/SchemaStatements/add_index"><code class="language-plaintext highlighter-rouge">add_index</code></a> method in your migration like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_index :posts, :user_id
</code></pre></div></div>

<p>You can use the <code class="language-plaintext highlighter-rouge">add_index</code> method to add an index on any column in the table.</p>

<h2 id="how-to-check-if-your-index-made-a-difference">How to check if your index made a difference</h2>

<p>So far, you’ve taken my word that indexing is a good thing which speeds up your app in ways that are relevant to business goals. But you don’t have to, because <strong>you can use <code class="language-plaintext highlighter-rouge">ActiveRecord's</code> <a href="http://guides.rubyonrails.org/active_record_querying.html#running-explain"><code class="language-plaintext highlighter-rouge">#explain</code></a> method to verify if adding an index made a difference to your query time or not</strong>. This will also help you determine the situations where indexing <em>doesn’t</em> give you much of a performance benefit.</p>

<p>The <code class="language-plaintext highlighter-rouge">#explain</code> method in <code class="language-plaintext highlighter-rouge">ActiveRecord</code> maps to the <code class="language-plaintext highlighter-rouge">EXPLAIN</code> command in <code class="language-plaintext highlighter-rouge">SQL</code>, and one of the things this command does is tell you how long the database thinks the query in question will take. The specifics of how the database formats this “explanation” and the units it measures “execution time” in depend on the database you’re using. Two common databases in the Rails world are <a href="http://www.postgresql.org/docs/current/static/using-explain.html">Postgres</a> and <a href="http://dev.mysql.com/doc/refman/5.6/en/explain-output.html">MySQL</a>, so I’ll give you the basics on those.</p>

<p>To see the output of the <code class="language-plaintext highlighter-rouge">#explain</code> method, you simply send the <code class="language-plaintext highlighter-rouge">#explain</code> message to the query you’re writing, like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Post.where(user_id: 23).explain
</code></pre></div></div>

<p>If you’re on a <strong>Postgres</strong> database, and you’ve run explain on a query, you’ll want to look at the <strong>cost</strong> numbers. The higher this number is, the longer the database thinks your query is going to take. You’ll typically see a range being output for cost.</p>

<p>If you’re on a <strong>MySQL</strong> database, you’ll want to look at the <strong>rows</strong> number, which tells you how many rows the database thinks its going to have to go through to get you a result. The higher this number, the longer the database thinks your query is going to take.</p>

<p><strong>In short, by using ‘#explain’ before and after you’ve added an index, you can see for yourself how much of a difference adding the index has made.</strong></p>

<p><a href="https://tomafro.net/2009/08/using-indexes-in-rails-index-your-associations">This article</a>, and <a href="https://tomafro.net/2009/08/using-indexes-in-rails-choosing-additional-indexes">this one</a>, written by <a href="https://tomafro.net/">Tom Ward</a>, a Rails contributor and developer at <a href="https://basecamp.com/">Basecamp</a>, are fantastic reads which go deeper into indexing and show you how you can make sense of the <code class="language-plaintext highlighter-rouge">explain</code> method’s output (he uses MySQL in his examples).</p>

<p><a href="https://tomafro.net/2009/09/quickly-list-missing-foreign-key-indexes">Tom also has this handy script</a>, which you can use to list any foreign keys you might have missed indexing.</p>

<h2 id="advanced-topics">Advanced Topics</h2>

<p>Indexing is a vast topic, and if you want to dig deeper, here are some starting points:</p>

<h3 id="a-free-book-on-indexing"><a href="http://use-the-index-luke.com/">A free book on indexing</a></h3>

<p>This book covers many things I didn’t cover here. Definitely worth a read.</p>

<h3 id="when-not-to-use-an-index">When not to use an index</h3>

<ol>
  <li><a href="http://searchsqlserver.techtarget.com/feature/When-not-to-use-indexes">Check this out</a>, and</li>
  <li><a href="http://dba.stackexchange.com/questions/56/how-to-determine-if-an-index-is-required-or-necessary">this</a>.</li>
</ol>

<h3 id="optimizing-indexes">Optimizing Indexes</h3>

<ol>
  <li><a href="http://www.sql-server-performance.com/2007/optimizing-indexes-general">Tips on optimizing indexes</a></li>
</ol>

<h3 id="terms-to-google">Terms to Google</h3>

<ol>
  <li>Partial Indexes</li>
  <li>Redundant Indexes</li>
</ol>

<p>As always, hit me up in the comments section if you’re stuck on anything in particular or if there’s a topic you want me to write more about. Cheers, and until next time!</p>

      </section>
      <section>
        <!-- Begin Mailchimp Signup Form -->
        <div id="mc-embed-signup">
          <form action="https://ducktypelabs.us10.list-manage.com/subscribe/post?u=f8e882c25616e4d0a58a53fc5&amp;id=e880b701c3" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
              <div id="mc_embed_signup_scroll">
            <h2 class="py-0 my-0 pb-4">Want to be notified when I publish a new article?</h2>
            <div class="form-container">
              <input placeholder="enter email" required type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
              <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
            </div>
            <div id="mce-responses">
              <div class="response" id="mce-error-response" style="display:none"></div>
              <div class="response" id="mce-success-response" style="display:none"></div>
            </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
            <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_f8e882c25616e4d0a58a53fc5_e880b701c3" tabindex="-1" value=""></div>
          </form>
        </div>
      </section>
      <footer>© Sid Krishnan</footer>
    </div>
  </body>
</html>
