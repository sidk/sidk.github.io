<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>All About Foreign Keys | Duck Type Labs</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="All About Foreign Keys" />
<meta name="author" content="Sid" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The concept of “foreign keys” in the Rails world has quite the potential to confuse, because, depending on the context of use, the intended meaning might actually differ! In addition, you might find yourself wondering how things like “references”, “foreign keys”, “associations” and “joins” are different, and why you should use one or not use the other." />
<meta property="og:description" content="The concept of “foreign keys” in the Rails world has quite the potential to confuse, because, depending on the context of use, the intended meaning might actually differ! In addition, you might find yourself wondering how things like “references”, “foreign keys”, “associations” and “joins” are different, and why you should use one or not use the other." />
<link rel="canonical" href="https://ducktypelabs.com/all-about-foreign-keys/" />
<meta property="og:url" content="https://ducktypelabs.com/all-about-foreign-keys/" />
<meta property="og:site_name" content="Duck Type Labs" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-01-10T13:22:22-05:00" />
<script type="application/ld+json">
{"url":"https://ducktypelabs.com/all-about-foreign-keys/","headline":"All About Foreign Keys","dateModified":"2016-01-10T13:22:22-05:00","datePublished":"2016-01-10T13:22:22-05:00","author":{"@type":"Person","name":"Sid"},"description":"The concept of “foreign keys” in the Rails world has quite the potential to confuse, because, depending on the context of use, the intended meaning might actually differ! In addition, you might find yourself wondering how things like “references”, “foreign keys”, “associations” and “joins” are different, and why you should use one or not use the other.","mainEntityOfPage":{"@type":"WebPage","@id":"https://ducktypelabs.com/all-about-foreign-keys/"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=f6b9e6ed502ef568e14c2ce9e1199c7d1e522e13">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      

      <p>The concept of “foreign keys” in the Rails world has quite the potential to confuse, because, depending on the context of use, <strong>the intended meaning might actually differ!</strong> In addition, you might find yourself wondering how things like “references”, “foreign keys”, “associations” and “joins” are different, and why you should use one or not use the other.</p>

<p>You’ve probably reached a point in your Rails life where you want to understand more about how ActiveRecord works with your database. As you’ve become familiar with the ActiveRecord API, you have built up an intuition about how things work, but you know that to build efficient and elegant web applications with Ruby and Rails, it will benefit you greatly to deepen your understanding.</p>

<h3 id="foreign-keys">Foreign Keys</h3>

<p>A foreign key is a mechanism that you can use to associate one table to another. Typically, it takes the form of a column with the name <code class="language-plaintext highlighter-rouge">&lt;other_table_name&gt;_id</code>. Let’s say you have a <code class="language-plaintext highlighter-rouge">User</code> table and a <code class="language-plaintext highlighter-rouge">Project</code> table, and you’ve used a <code class="language-plaintext highlighter-rouge">has_many</code> on <code class="language-plaintext highlighter-rouge">User</code>, you’ll see that a statement like <code class="language-plaintext highlighter-rouge">user.projects</code> when translated into SQL by ActiveRecord will automatically use <code class="language-plaintext highlighter-rouge">user_id</code> as a foreign key. Check it out yourself and see, try:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user.projects.to_sql
</code></pre></div></div>

<p>in your console. You should see an SQL statement that is searching for all projects with a <code class="language-plaintext highlighter-rouge">user_id</code> corresponding to <code class="language-plaintext highlighter-rouge">user</code>‘s ID.</p>

<p>ActiveRecord relies on this column to figure out which projects of all in the <code class="language-plaintext highlighter-rouge">projects</code> table are “related” or “associated” to the given user.</p>

<p>You probably know that doing <code class="language-plaintext highlighter-rouge">has_many</code> is not enough. You will also have to add a column to the <code class="language-plaintext highlighter-rouge">Project</code> table with the name <code class="language-plaintext highlighter-rouge">user_id</code>. Your migration might look like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_column :projects, :user_id, :integer
</code></pre></div></div>

<p>Newer versions of ActiveRecord also provide the <code class="language-plaintext highlighter-rouge">#references</code> and <code class="language-plaintext highlighter-rouge">#add_reference</code> method, which take care of adding the foreign key column for you. So, instead of using the <code class="language-plaintext highlighter-rouge">add_column</code> method, you can use the <code class="language-plaintext highlighter-rouge">add_reference</code> method, like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_reference :projects, :user
</code></pre></div></div>

<p>This will add a <code class="language-plaintext highlighter-rouge">user_id</code> column to the <code class="language-plaintext highlighter-rouge">projects</code> table. <strong>The advantage with using the <code class="language-plaintext highlighter-rouge">reference</code> method is that you can add an index and a database constraint on the foreign key painlessly as well.</strong></p>

<p>Check out <a href="http://guides.rubyonrails.org/association_basics.html">this doc</a> and <a href="http://edgeguides.rubyonrails.org/active_record_migrations.html">this doc</a> for more info.</p>

<h3 id="referential-integrity">Referential Integrity</h3>

<p>If you were wondering what I meant when I said ‘database constraint on the foreign key’, rest assured, because I’m going to cover what that means here.</p>

<p>It depends on who you’re talking to, but in many contexts, a foreign key in the Rails world is understood plainly as the column itself. Depending on your use case, this could be enough. Keep in mind though, that the problem with this approach is that <strong>when we only have a foreign key column, we have no way of ensuring that for a given value of <code class="language-plaintext highlighter-rouge">user_id</code>, a corresponding <code class="language-plaintext highlighter-rouge">User</code> record actually exists</strong>. This has the potential to lead to confusion down the line.</p>

<p>To know what I mean, fire up your console and try the following (assuming you have the same setup as above, and that we have one <code class="language-plaintext highlighter-rouge">User</code> in the system with <code class="language-plaintext highlighter-rouge">ID = 1</code>)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project = Project.create(name: 'hit song', user_id: 2)
</code></pre></div></div>

<p>You should be able to create the project, but when you do <code class="language-plaintext highlighter-rouge">project.user</code>, you’ll get back <code class="language-plaintext highlighter-rouge">nil</code>. AKA an <em>orphaned</em> project. You can solve this with a <code class="language-plaintext highlighter-rouge">validates</code> in your model to ensure uniqueness and/or presence of the <code class="language-plaintext highlighter-rouge">user</code>, but you might find yourself in a situation where you’re bypassing validation callbacks somehow (probably with a bulk operation), and yet again creating orphans.</p>

<p><strong>What solves this problem, is getting the <em>database</em> to ensure that orphaned records are not created.</strong></p>

<p>Enter the <code class="language-plaintext highlighter-rouge">add_foreign_key</code> method, which you’ll notice is <strong>sort of a second meaning for the term ‘foreign key’</strong>. Using this method in your migration tells the database (in the way only ActiveRecord knows how) to enforce <em>referential integrity</em> by adding a <em>foreign key constraint</em>.</p>

<p><a href="https://robots.thoughtbot.com/referential-integrity-with-foreign-keys">This very good article from the robots at thoughtbot</a> goes into many of the finer details of this concept, and why it’s important.</p>

<p>You’d use it like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_column :projects, :user_id
add_foreign_key :projects, :users
</code></pre></div></div>

<p><a href="http://edgeguides.rubyonrails.org/active_record_migrations.html#foreign-keys">This Rails doc</a> gives some additional details.</p>

<p>If you’re using the <code class="language-plaintext highlighter-rouge">add_reference</code> method, you can pass in a boolean to indicate if a foreign key constraint is to be added, like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_reference :projects, :user, foreign_key: true
</code></pre></div></div>

<h3 id="the-joins-method">The <code class="language-plaintext highlighter-rouge">.joins</code> method</h3>

<p>If you came to Rails without a background in SQL (like me), you’ve probably wondered about the <code class="language-plaintext highlighter-rouge">.joins</code> method, how it is related to the concept of associations and foreign keys, and when you should use it.</p>

<p>The rule of thumb with the <code class="language-plaintext highlighter-rouge">.joins</code> method is that <strong>you need to use it when you need to query more than one table at the same time</strong>.</p>

<p>In other words, if the query you’re writing for a given table/model needs to reference attributes in another table (or more), you will need to invoke <code class="language-plaintext highlighter-rouge">.joins</code> to make this happen. This holds true <em>regardless of if the tables are associated to each other with a foreign key column or constraint</em>.</p>

<p>So for example, if we want to query the <code class="language-plaintext highlighter-rouge">projects</code> table for all projects that are owned by a user of role ‘manager’ (assuming we have a ‘role’ column on the <code class="language-plaintext highlighter-rouge">users</code> table), we’d do:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Project.joins(:user).where(user: { role: 'manager' })
</code></pre></div></div>

<p>You’ll notice that if you try this without the <code class="language-plaintext highlighter-rouge">.joins</code>, ActiveRecord will complain.</p>

<p>For some background on joins, check out this <a href="http://www.sql-join.com/">nice summary on the different types of joins you can do in SQL.</a> <strong>You can even use the <code class="language-plaintext highlighter-rouge">.joins</code> method to query multiple tables that are not associated to one another if you so choose.</strong> I encourage you to fire up the console and use the <code class="language-plaintext highlighter-rouge">.to_sql</code> method for your queries whenever you’re stuck to get a better handle on what ActiveRecord is doing behind the scenes.</p>

<p>Hope this helped, and as always, please leave a comment below if you’re stuck on something that you need help with or if something above was unclear in any way. I’d love to help out!</p>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
