<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>How to use has_many :through with additional attributes on the join table</title>
    <link rel="stylesheet" href="/assets/css/style.css">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      <nav>
        <a href="/">About</a>
      </nav>
      <h1>How to use has_many :through with additional attributes on the join table</h1>
      <section>
        <p>A common area where developers can get hung up is when using <code class="language-plaintext highlighter-rouge">has_many :through</code>. <code class="language-plaintext highlighter-rouge">has_many :through</code> essentially allows you to link two models together with a “join table”. Though it can be pretty simple to work with, things can get confusing when you find yourself having to pass and store additional attributes in this join table.</p>

<blockquote>
  <p>“I have read every post on the internet pertaining to has_many through with additional attributes on the join table and I am still not getting it”</p>

  <p>“how do you store extra info in the join model and extract that out later?”</p>
</blockquote>

<p>If you followed along <a href="http://ducktypelabs.com/how-a-has_many-through-association-works-in-practice/">my previous post</a>, at this point you should have a good idea of how to write your models, controllers and views such that you can create, display and edit records which use a <code class="language-plaintext highlighter-rouge">has_many :through</code> association. If you’re still stuck on that, leave a comment below and I’ll try to sort you out. Make sure to check out <a href="http://railscasts.com/episodes/17-habtm-checkboxes-revised">Ryan Bates screencast</a> on the basics, and also checkout <a href="http://theartandscienceofruby.com/2015/06/23/which-activerecord-association-should-i-use-has-and-belongs-to-many-or-has-many-through/">Rahoul’s article</a> on when you should <code class="language-plaintext highlighter-rouge">has_many</code> in the first place.</p>

<p>So, what do you do when you want to store/access additional attributes in the join table?</p>

<p>You already know how to set up your view form so that it passes in parameters to your controller and correctly creates a new record in the join table. If you’re using checkboxes in your view, the checkbox code probably looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% Group.all.each do |group| %&gt;
  &lt;%= check_box_tag "user[group_ids][]", group.id, @user.group_ids.include?(group.id) %&gt;
  &lt;%= group.name %&gt;
  &lt;br /&gt;
&lt;% end %&gt;
</code></pre></div></div>

<p>…assuming that you have a <code class="language-plaintext highlighter-rouge">User</code> and <code class="language-plaintext highlighter-rouge">Group</code> models and a <code class="language-plaintext highlighter-rouge">UserGroup</code> which functions as the join.</p>

<p>And your controller <code class="language-plaintext highlighter-rouge">#create</code> action should be very similar to this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def create
  User.create!(user_params)
end

def user_params
  params.require(:user).permit(group_ids: [])
end
</code></pre></div></div>

<p>As you can see, we don’t have to do anything special in the controller because <code class="language-plaintext highlighter-rouge">group_ids</code> will be accepted as a parameter (it is part of the dynamic programming which happens when you call <code class="language-plaintext highlighter-rouge">has_many</code>). You do have to correctly permit the <code class="language-plaintext highlighter-rouge">group_ids</code> param though.</p>

<p>Now, let’s say for a given user you want to specify if they are an admin of the group or not, via checkbox.</p>

<p>I’m going to assume that we will have an edit page for each group record, and on this page, we will see all the users that belong to this group along with a checkbox next to each user indicating if they are an admin or not.</p>

<h3 id="the-view">The View</h3>

<p>In my group edit page, I want to show the users that are in the group and next to each user show a checkbox allowing me to select if the user is going to be an admin.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= form_for @group do |f| %&gt;
  &lt;%= @group.inspect %&gt;
  &lt;br /&gt;
  &lt;% if @group.user_groups.present? %&gt;
    &lt;%= f.fields_for :user_groups do |ugf| %&gt;
      &lt;% user = ugf.object.user %&gt;
      &lt;%= user.name %&gt;
      Admin?
      &lt;%= ugf.check_box :admin %&gt;
      &lt;br /&gt;
    &lt;% end %&gt;
  &lt;% else %&gt;
    No Users in this group yet
  &lt;% end %&gt;
  &lt;%= f.submit 'Update group' %&gt;
&lt;% end %&gt;
</code></pre></div></div>

<p>Couple of things to note here:</p>

<p>1) I’m using the <code class="language-plaintext highlighter-rouge">user_groups</code> association. By using <code class="language-plaintext highlighter-rouge">fields_for</code> on this association, I can treat it like any other association of <code class="language-plaintext highlighter-rouge">group</code> and build a custom form for it.</p>

<p>2) When submitting this form, the <code class="language-plaintext highlighter-rouge">user_groups</code> parameters will be passed in under the <code class="language-plaintext highlighter-rouge">user_groups_attributes</code> key in the <code class="language-plaintext highlighter-rouge">params</code> hash.</p>

<h3 id="the-model">The Model</h3>

<p>To be able to pass in a hash with <code class="language-plaintext highlighter-rouge">user_groups_attributes</code> to the <code class="language-plaintext highlighter-rouge">Group</code> model and call <code class="language-plaintext highlighter-rouge">update</code> or <code class="language-plaintext highlighter-rouge">save</code> on it, we need to use the <code class="language-plaintext highlighter-rouge">accepts_nested_attributes_for</code> method. This method tells Rails and ActiveRecord how to correctly deal with <code class="language-plaintext highlighter-rouge">user_groups_attributes</code> being in the <code class="language-plaintext highlighter-rouge">params</code> hash.</p>

<p>Our <code class="language-plaintext highlighter-rouge">Group</code> would look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Group &lt; ActiveRecord::Base
  has_many :user_groups
  has_many :users, through: :groups
  accepts_nested_attributes_for :user_groups
end
</code></pre></div></div>

<p>So the parameter we pass in to <code class="language-plaintext highlighter-rouge">accepts_nested_attributes_for</code> is the model/association we want to accept nested attributes for.</p>

<h3 id="the-controller">The Controller</h3>

<p>Because of the setup we did above in the <code class="language-plaintext highlighter-rouge">Group</code> model, we can now use the usual <code class="language-plaintext highlighter-rouge">update</code> method with the params that we get from the view/form.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def update
  @group = Group.find(params[:id])
  @group.update(group_params)
end

def group_params
  params.require(:group).permit(user_groups_attributes: [:admin, :id])
end
</code></pre></div></div>

<p>If you’re using Rails 4 and <code class="language-plaintext highlighter-rouge">strong_parameters</code>, you will have to make sure you permit the correct parameters.</p>

<p>And that’s it! You should now be able to update this admin attribute on the <code class="language-plaintext highlighter-rouge">UserGroup</code> join table. You can follow the same approach for different types of data as well (like a text field for example). I encourage you to look deeper into what the params hash looks like once it gets to the controller so that you get more comfortable with it. Play with this idea in Rails console as well to increase your confidence.</p>

<p>I’ve posted an <a href="https://github.com/sidk/has_many_through_with_additional_attributes">example app on github</a> – check it out if you need more info about how exactly to get this to work. If you’re still stuck, or are dealing with a use case which is not similar to this, post in the comments section below and I’ll try to help.</p>

      </section>
      <section>
        <!-- Begin Mailchimp Signup Form -->
        <div id="mc-embed-signup">
          <form action="https://ducktypelabs.us10.list-manage.com/subscribe/post?u=f8e882c25616e4d0a58a53fc5&amp;id=e880b701c3" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
              <div id="mc_embed_signup_scroll">
            <h2 class="py-0 my-0 pb-4">Want to be notified when I publish a new article?</h2>
            <div class="form-container">
              <input placeholder="enter email" required type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
              <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
            </div>
            <div id="mce-responses">
              <div class="response" id="mce-error-response" style="display:none"></div>
              <div class="response" id="mce-success-response" style="display:none"></div>
            </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
            <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_f8e882c25616e4d0a58a53fc5_e880b701c3" tabindex="-1" value=""></div>
          </form>
        </div>
      </section>
      <footer>© Sid Krishnan</footer>
    </div>
  </body>
</html>
